<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR å…«å¤§è¡Œæ˜ŸéŸ³æ¨‚ç¥­</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS æ¨£å¼ä¿æŒä¸è®Š */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #16213e;
        }
        
        /* ==================== å…±äº«/ä¸»é¸å–®æ¨£å¼ ==================== */
        #menu-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100;
            transition: opacity 0.5s ease;
        }
        
        #menu-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        #menu-screen.visible {
            opacity: 1;
            pointer-events: all;
        }
        
        .background-image {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
        }
        
        @keyframes float {
            0% { transform: translateY(0px);
            }
            50% { transform: translateY(-8px);
            } 
            100% { transform: translateY(0px);
            }
        }

        .circle-button {
            position: absolute;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: transparent; 
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: float 4s ease-in-out infinite;
        }
        
        .circle-button:hover {
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
            box-shadow: 0 12px 48px rgba(255, 255, 255, 0.2);
        }

        .circle-button.is-active {
            animation: none;
            transform: translateY(0px) scale(1.1);
            box-shadow: 0 0 50px rgba(255, 152, 0, 0.8);
        }

        .circle-button img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }
        
        #info-panel {
            position: fixed;
            display: none;
            z-index: 50;
            width: 250px;
            padding: 20px;
            border-radius: 10px;
            background: rgba(45, 52, 71, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.7);
            transition: opacity 0.3s ease;
            pointer-events: none;
            color: white;
            opacity: 0;
        }
        
        #info-panel.visible {
            display: block;
            opacity: 1;
        }
        
        /* ==================== 3D å ´æ™¯ & éŠæˆ²æ¨£å¼ ==================== */
        #scene-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        
        #scene-container.active {
            opacity: 1;
            pointer-events: all;
        }

        /* éŠæˆ²ç–Šå±¤ (HUD) æ¨£å¼ */
        #game-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10; 
            display: none;
            color: white;
            font-family: sans-serif;
            pointer-events: none;
        }
        
        /* æ­¡è¿ç•«é¢ (Welcome) æ¨£å¼ - **ç´”ç™½é¢¨æ ¼ä¿®æ”¹** */
        #welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            opacity: 0;
            transition: opacity 1.2s ease-in;
        }
        
        #welcome-screen.fade-in {
            opacity: 1;
        }
        
        /* æ–‡å­—æ•ˆæœ - ç´”ç™½è‰²ç°¡æ½”é¢¨æ ¼ */
        #welcome-screen h1 {
            color: #ffffff;
            /* ç´”ç™½è‰² */
            text-shadow: 
                0 0 5px rgba(255, 255, 255, 0.5), /* æŸ”å’Œç™½å…‰ */
                0 0 10px rgba(255, 255, 255, 0.2);
            animation: none; /* ç§»é™¤éœ“è™¹é–ƒçˆå‹•ç•« */
        }
        
        /* ç§»é™¤åŸæœ‰çš„ neon-flicker å‹•ç•«å®šç¾© */
        /* @keyframes neon-flicker { ... } */
        
        #welcome-screen p {
            color: #ffffff;
            text-shadow: 0 0 3px rgba(255, 255, 255, 0.2); /* æŸ”å’Œç™½è‰²é™°å½± */
        }
        
        /* çµç®—ç•«é¢ (Summary) æ¨£å¼ - **ç´”ç™½é¢¨æ ¼ä¿®æ”¹** */
        #summary-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a0a 0%, #100020 50%, #000a10 100%);
            /* ä¿æŒæ·±è‰²èƒŒæ™¯ */
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            overflow: hidden;
        }
        
        /* è³½åšæœ‹å…‹èƒŒæ™¯ç¶²æ ¼ - ä¿æŒä¸è®Š */
        #summary-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: grid-move 20s linear infinite;
            pointer-events: none;
        }
        
        @keyframes grid-move {
            0% { transform: translateY(0);
            }
            100% { transform: translateY(50px);
            }
        }
        
        /* çµç®—æ¨™é¡Œ - **ç´”ç™½é¢¨æ ¼ä¿®æ”¹** */
        #summary-screen h1 {
            position: relative;
            z-index: 1;
            font-size: 72px;
            font-weight: 900;
            color: #ffffff; /* ç´”ç™½è‰² */
            text-shadow: 
                0 0 5px rgba(255, 255, 255, 0.5),
                0 0 10px rgba(255, 255, 255, 0.3);
            animation: none; /* ç§»é™¤ glitch å‹•ç•« */
            margin-bottom: 40px;
        }
        
        /* ç§»é™¤åŸæœ‰çš„ cyberpunk-glitch å‹•ç•«å®šç¾© */
        /* @keyframes cyberpunk-glitch { ... } */
        
        /* åˆ†æ•¸é¡¯ç¤º */
        #summary-screen p {
            position: relative;
            z-index: 1;
            font-size: 32px;
            color: #ffffff;
            margin: 20px 0;
        }

        /* æœ€çµ‚å¾—åˆ† - **ç´”ç™½é¢¨æ ¼ä¿®æ”¹** */
        #final-score {
            font-size: 64px;
            font-weight: bold;
            color: #ffffff; /* ç´”ç™½è‰² */
            text-shadow: 
                0 0 5px rgba(255, 255, 255, 0.8),
                0 0 10px rgba(255, 255, 255, 0.5);
            animation: score-pulse 1.5s infinite;
        }
        
        @keyframes score-pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
                /* è„ˆè¡æ•ˆæœè¼•å¾®ç¸®å° */
            }
        }
        
        /* æ­¡è¿ç•«é¢æŒ‰éˆ• - **ç´”ç™½é¢¨æ ¼ä¿®æ”¹** */
        #welcome-screen button {
            margin: 15px 10px;
            padding: 15px 40px;
            font-size: 24px;
            background: transparent;
            color: #ffffff; /* ç´”ç™½è‰² */
            border: 2px solid #ffffff;
            /* ç´”ç™½è‰²é‚Šæ¡† */
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            pointer-events: auto;
            text-shadow: 0 0 3px rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 0 5px rgba(255, 255, 255, 0.5),
                inset 0 0 5px rgba(255, 255, 255, 0.15);
        }
        
        #welcome-screen button:hover {
            background: rgba(255, 255, 255, 0.1);
            /* è¼•å¾®èƒŒæ™¯è‰² */
            color: #ffffff;
            text-shadow: none;
            box-shadow: 
                0 0 10px rgba(255, 255, 255, 0.8),
                0 0 15px rgba(255, 255, 255, 0.5),
                inset 0 0 10px rgba(255, 255, 255, 0.3);
        }
        
        /* çµç®—ç•«é¢æŒ‰éˆ• - **ç´”ç™½é¢¨æ ¼ä¿®æ”¹** */
        #summary-screen button {
            position: relative;
            z-index: 1;
            margin: 15px 10px;
            padding: 18px 45px;
            font-size: 24px;
            background: transparent;
            /* ç§»é™¤æ¼¸è®ŠèƒŒæ™¯ */
            color: #ffffff;
            /* ç´”ç™½è‰² */
            border: 2px solid #ffffff;
            /* ç´”ç™½è‰²é‚Šæ¡† */
            border-radius: 5px;
            /* æ”¹ç‚ºæ¨™æº–åœ“è§’ */
            cursor: pointer;
            transition: all 0.3s;
            pointer-events: auto;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 
                0 0 5px rgba(255, 255, 255, 0.5),
                inset 0 0 5px rgba(255, 255, 255, 0.2);
            clip-path: none; /* ç§»é™¤ä¸è¦å‰‡å‰ªè£ */
        }
        
        #summary-screen button:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.05) translateY(-2px);
            box-shadow: 
                0 0 10px rgba(255, 255, 255, 0.8),
                0 0 15px rgba(255, 255, 255, 0.5),
                0 5px 15px rgba(0, 0, 0, 0.5),
                inset 0 0 10px rgba(255, 255, 255, 0.2);
        }
        
        #summary-screen button:active {
            transform: scale(0.98) translateY(0);
        }

        /* é»æ“Šå›é¥‹ */
        #feedback-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            opacity: 0;
            transition: all 0.1s ease-out;
            pointer-events: none;
            z-index: 50;
        }

        /* éŠæˆ²å…ƒç´  - é»æ“Šç›®æ¨™ */
        #target-circle {
            position: absolute;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(255, 152, 0, 0.8); 
            border: 4px solid white;
            box-shadow: 0 0 20px #ff9800;
            left: 50%;
            top: 75%; 
            transform: translate(-50%, -50%);
            z-index: 20;
            pointer-events: auto;
            /* å…è¨±é»æ“Š */
            cursor: pointer;
        }
        
        /* éŠæˆ²å…ƒç´  - ç¯€å¥é» */
        .beat-note {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0, 200, 255, 0.9);
            border: 2px solid white;
            box-shadow: 0 0 10px #00c8ff;
            left: 50%;
            top: 0;
            transform: translate(-50%, 0);
            pointer-events: none;
            will-change: transform, opacity;
        }
        
        /* HUD é ‚éƒ¨ */
        #hud-top {
            position: absolute;
            top: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 50px;
            pointer-events: none;
            /* è®“é»æ“Šç©¿é€åˆ°éŠæˆ²å…ƒç´  */
        }
        
        #hud-score {
            font-size: 36px;
            font-weight: bold;
            color: #ff9800;
        }
        
        #hud-harmony {
            font-size: 20px;
            color: white;
            margin-top: 10px;
        }

        /* ç¤ºæ„åœ–èƒŒæ™¯ */
        #game-reference {
            position: fixed;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.1; 
            z-index: -1;
            display: none;
        }
        
        /* è¿”å›æŒ‰éˆ•å’Œæš«åœæŒ‰éˆ•çš„åŸºç¤æ¨£å¼ */
        .control-button {
            position: fixed;
            top: 20px;
            z-index: 200;
            padding: 12px 24px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }

        .control-button.visible {
            opacity: 1;
            pointer-events: all;
        }

        #back-button {
            left: 20px;
        }

        #pause-button {
            right: 20px;
        }
        
        #scene-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 5px;
            font-size: 14px;
            max-width: 300px;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        #scene-info.visible {
            opacity: 1;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px 40px;
            border-radius: 10px;
            z-index: 300;
            display: none;
        }
        
        /* æš«åœé¸å–® */
        #pause-menu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 40px 60px;
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            z-index: 150;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        #pause-menu h2 {
            color: white;
            font-size: 36px;
            margin: 0 0 20px 0;
        }
        
        #pause-menu button {
            padding: 15px 40px;
            font-size: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 200px;
        }
        
        #pause-menu button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div id="menu-screen" class="visible">
        <img src="assets/home background.png" alt="å®‡å®™èƒŒæ™¯" class="background-image">
        
        <div class="relative w-screen h-screen flex items-center justify-center">
            <div id="button-container" class="relative w-full h-full"></div>
            
            <div id="info-panel">
        
                <h3 class="text-xl font-bold mb-2" id="info-title"></h3>
                <p class="text-sm" id="info-description"></p>
            </div>
        </div>
    </div>
    
    <div id="scene-container"></div>
    
    <div id="welcome-screen">
        <h1 class="text-6xl font-extrabold mb-4" id="welcome-title">æ­¡è¿ä¾†åˆ°æœ¨æ˜Ÿèˆå°</h1>
        <p class="text-2xl mb-8" id="welcome-intro">è·Ÿè‘—å˜»å“ˆç¯€å¥ï¼Œé»æ“Šåœ“åœˆï¼Œç¶­æŒå®Œç¾å’Œè«§ï¼</p>
       
        <p class="text-xl text-gray-400" id="welcome-message">éŠæˆ²å³å°‡é–‹å§‹ï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•å•Ÿå‹•éŸ³æ¨‚ã€‚</p>
        <button id="start-game-button">é–‹å§‹éŠæˆ²</button>
    </div>

    <div id="summary-screen">
        <h1>MISSION COMPLETE</h1>
        <p style="font-size: 28px; color: #ffffff;
text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);">æœ€çµ‚å¾—åˆ†</p>
        <p><span id="final-score">0000</span></p>
        <div style="display: flex;
gap: 20px; margin-top: 40px;">
            <button id="restart-game-button">é‡æ–°é–‹å§‹</button>
            <button id="exit-to-menu-button">è¿”å›ä¸»é¸å–®</button>
        </div>
    </div>

    <div id="game-overlay">
        <img id="game-reference" src="Gemini_Generated_Image_7kttr27kttr27ktt.jpg" alt="éŠæˆ²ç¤ºæ„åœ–">

        <div id="hud-top">
            <div id="hud-left">
                <div id="hud-score">SCORE: 0000</div>
   
                <div id="hud-harmony">PERFECT HARMONY</div>
            </div>
        </div>

        <div id="target-circle"></div>
        
    </div>
    
    <button id="back-button" class="control-button">â† è¿”å›ä¸»é¸å–®</button>
    <button id="pause-button" class="control-button">â¸ æš«åœ</button>
    
    <div id="pause-menu">
        <h2>éŠæˆ²æš«åœ</h2>
        <button 
id="resume-button">ç¹¼çºŒéŠæˆ²</button>
        <button id="home-button">è¿”å›ä¸»é </button>
    </div>
    
    <div id="scene-info">
        <strong>éŠæˆ²èªªæ˜ï¼š</strong><br>
        â€¢ é»æ“Šç›®æ¨™åœ“åœˆ (æ©˜è‰²) ä¾†æ•æ‰è—è‰²ç¯€å¥é»ã€‚<br>
        â€¢ ç¯€å¥é»æœƒåœ¨éŸ³æ¨‚é–‹å§‹å¾Œå¾ä¸Šæ–¹è½ä¸‹ã€‚
    </div>

    <div id="loading">è¼‰å…¥ä¸­...</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fflate@0.7.4/umd/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/FBXLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        // ==================== å…¨åŸŸè®Šæ•¸èˆ‡éŠæˆ²ç‹€æ…‹ ====================
      
        let scene, camera, renderer, controls, mixer, clock, deltaPauseTime = 0;
        let activeInfoButton = null;
        let sceneInitialized = false;
        let animationFrameId = null; // å„²å­˜ requestAnimationFrame çš„ ID
        let currentPlanet = null; // æ–°å¢ï¼šç•¶å‰èˆå°æ˜Ÿçƒ

        
        const GAME_STATE = {
            MENU: 'MENU',
            WELCOME: 'WELCOME',
            PLAYING: 'PLAYING',
            PAUSED: 'PAUSED', // æ–°å¢ï¼šæš«åœç‹€æ…‹
            SUMMARY: 'SUMMARY' // æ–°å¢ï¼šçµç®—ç‹€æ…‹
    
        };
        let currentState = GAME_STATE.MENU;
        
        // --- éŸ³é »èˆ‡éŠæˆ²æ ¸å¿ƒè®Šæ•¸ ---
        let audioListener;
        let ambientMusic; 
        let audioLoaded = false;
        let audioStartTime = 0; 
        let score = 0;
        // ç¯€å¥åƒæ•¸ (å„ªåŒ–å¾Œçš„é›£åº¦)
        const BPM = 95; 
        const BEAT_INTERVAL = 60 / BPM;
        const NOTES_PER_BEAT = 1; // å¾ 2 æ”¹ç‚º 1ï¼Œæ¯æ‹åªæœ‰1å€‹éŸ³ç¬¦
        const NOTE_INTERVAL = BEAT_INTERVAL / NOTES_PER_BEAT;
        const DROP_DURATION = 1.8; // å¾ 1.5 å¢åŠ åˆ° 1.8ï¼Œçµ¦ç©å®¶æ›´å¤šåæ‡‰æ™‚é–“
        const TARGET_Y = 0.75;
        const MAX_NOTES = 50; // å¾ 100 æ¸›å°‘åˆ° 50 
        let noteTimetable = [];
        // åœ¨ loadAssetForPlanet ä¸­è¨­å®š noteTimetable
        let nextNoteIndex = 0;

        const BUTTON_RADIUS_HALF = 60;
        const INFO_BOX_OFFSET = BUTTON_RADIUS_HALF + 25;

        const buttons = [
            { icon: 'assets/åœŸ.png', text: 'åœŸæ˜Ÿå…‰ç’°', description: 'çˆµå£«è¿´å»Š â€“ åœ¨å…‰ç’°ä¸‹æ²‰é†‰ï¼Œå“å‘³è—èª¿çš„é†‡åšèˆ‡çˆµå£«çš„å³èˆˆã€‚', planet: 'saturn' },
            { icon: 'assets/å¤©.png', text: 'å¤©ç‹æ˜Ÿç¨œé¡', description: 'å¯¦é©—éŸ³æ³¢ â€“ æŒ‘æˆ°è½è¦ºæ¥µé™ï¼Œè§£é–å‰è¡›è²éŸ¿çš„æ–°ç¶­åº¦ã€‚', planet: 'uranus' },
            { icon: 'assets/æœ¨.png', text: 'æœ¨æ˜Ÿé›²åœ–', description: 'å˜»å“ˆç–†åŸŸ â€“ æŒæ¡æ½®æµè„ˆå‹•ï¼Œé ˜ç•¥è¡—é ­æ–‡åŒ–çš„å¤šå…ƒé¢¨è²Œã€‚', planet: 'jupiter' },
            { icon: 'assets/æ°´.png', text: 'æ°´æ˜Ÿä¹‹è»Œ', description: 'é›»å­è¶…è¼‰ â€“ æ„Ÿå—Tranceçš„è¿·å¹»è„ˆå‹•ï¼Œé«”é©—Technoçš„é‡åŠ›åŠ é€Ÿåº¦ã€‚', planet: 'mercury' },
            { icon: 'assets/ç«.png', text: 'ç«æ˜Ÿæ ¸å¿ƒ', description: 'æ–æ»¾ç‹‚ç€¾ â€“ é»ç‡ƒè…ä¸Šè…ºç´ ï¼Œæ„Ÿå—é‡é‡‘å±¬çš„åŸå§‹çˆ†ç™¼åŠ›ã€‚', planet: 'mars' },
            { icon: 'assets/åœ°.png', text: 'åœ°çƒå…±é³´', description: 'ç¨ç«‹è²ç•Œ â€“ ä¾†è‡ªå…¨çƒçš„ç¨ç«‹ä¹‹è²ï¼Œæ¢ç´¢éŸ³æ¨‚çš„ç„¡é™å¯èƒ½ã€‚', planet: 'earth' },
            { icon: 'assets/é‡‘.png', text: 'é‡‘æ˜Ÿç†±æµª', description: 'æ‹‰ä¸é¢¨æš´ â€“ åœ¨ç‚™ç†±ç¯€å¥ä¸­æ–æ“ºï¼Œé‡‹æ”¾æœ€å¥”æ”¾çš„éˆé­‚ã€‚', planet: 'venus' },
            { icon: 'assets/æµ·.png', text: 'æµ·ç‹æ˜Ÿæ·±æ·µ', description: 'è¿·å¹»è¿´è² â€“ æ½›å…¥æ·±è—å¤¢å¢ƒï¼Œè®“éŸ³ç¬¦å¸¶ä½ é€²å…¥å†¥æƒ³ã€‚', planet: 'neptune' }
       
        ];

        // ==================== ä¸»é¸å–®åŠŸèƒ½ (ä¿æŒä¸è®Š) ====================
        function hideInfoBox() {
            const panel = document.getElementById('info-panel');
            if (activeInfoButton) {
                activeInfoButton.style.border = '2px solid rgba(255, 255, 255, 0.3)';
                activeInfoButton.classList.remove('is-active');
            }
            panel.classList.remove('visible');
            setTimeout(() => {
                panel.style.display = 'none';
            }, 300);
            activeInfoButton = null;
        }
        
        function handleButtonClick(btn, buttonElement) {
            const panel = document.getElementById('info-panel');
            // ç¬¬äºŒæ¬¡é»æ“Šï¼šé€²å…¥å ´æ™¯
            if (activeInfoButton === buttonElement) {
                if (btn.planet === 'jupiter' || btn.planet === 'mercury') { // å…è¨±é€²å…¥æ°´æ˜Ÿå’Œæœ¨æ˜Ÿ
                    enterScene(btn.planet);
                } else {
                    alert(`${btn.text} å ´æ™¯é–‹ç™¼ä¸­...`);
                }
                return;
            }
            
            // ç¬¬ä¸€æ¬¡é»æ“Šï¼šé¡¯ç¤ºè³‡è¨Š
            if (activeInfoButton) {
                hideInfoBox();
            }
            
            activeInfoButton = buttonElement;
            buttonElement.style.border = '2px solid #ff9800';
            buttonElement.classList.add('is-active');
            
            document.getElementById('info-title').textContent = btn.text;
            document.getElementById('info-description').textContent = btn.description;
            
            const rect = buttonElement.getBoundingClientRect();
            const btnCenterX = rect.left + rect.width / 2;
            const btnCenterY = rect.top + rect.height / 2;
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            const angle = Math.atan2(btnCenterY - centerY, btnCenterX - centerX);
            
            let panelCenterX = btnCenterX + Math.cos(angle) * INFO_BOX_OFFSET;
            let panelCenterY = btnCenterY + Math.sin(angle) * INFO_BOX_OFFSET;
            
            panel.style.display = 'block';
            const panelWidth = panel.offsetWidth;
            const panelHeight = panel.offsetHeight;
            let finalLeft = panelCenterX - panelWidth / 2;
            let finalTop = panelCenterY - panelHeight / 2;
            
            const PADDING = 20;
            finalLeft = Math.max(PADDING, Math.min(finalLeft, window.innerWidth - panelWidth - PADDING));
            finalTop = Math.max(PADDING, Math.min(finalTop, window.innerHeight - panelHeight - PADDING));
            panel.style.left = `${finalLeft}px`;
            panel.style.top = `${finalTop}px`;
            panel.classList.add('visible');
        }
        
        function createCircularButtons() {
            const container = document.getElementById('button-container');
            container.innerHTML = '';
            
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            const radius = Math.min(centerX, centerY) * 0.6;
            
            buttons.forEach((btn, index) => {
                const angle = (index / buttons.length) * 2 * Math.PI - Math.PI / 2;
                const x = centerX + radius * Math.cos(angle) - 60;
                const y = centerY + radius * Math.sin(angle) - 60;
           
             
                const button = document.createElement('div');
                button.className = 'circle-button';
                button.style.left = x + 'px';
                button.style.top = y + 'px';
                button.style.animationDelay = 
                `${index * 0.1}s`;
                button.innerHTML = `<img src="${btn.icon}" alt="${btn.text}">`;
                
                button.onclick = (e) => {
                    e.stopPropagation();
                    handleButtonClick(btn, button);
 
                };
                
                container.appendChild(button);
            });
        }
        
        // ==================== éŠæˆ²æ ¸å¿ƒæµç¨‹æ§åˆ¶ (Start/Pause/End) ====================

        function loadAssetForPlanet(planet) {
            let modelPath = '';
            let audioPath = '';
            let title = '';
            let intro = '';

            // é‡ç½® noteTimetable
            noteTimetable = [];
            for (let i = 0; i < MAX_NOTES; i++) {
                noteTimetable.push(i * NOTE_INTERVAL);
            }
            
            if (planet === 'jupiter') {
                modelPath = 'assets/æœ¨æ˜Ÿæ­Œæ‰‹+èˆå°.fbx';
                audioPath = 'assets/æœ¨æ˜ŸéŸ³æ¨‚2.mp3';
                title = 'æ­¡è¿ä¾†åˆ°æœ¨æ˜Ÿèˆå°';
                intro = 'è·Ÿè‘—å˜»å“ˆç¯€å¥ï¼Œé»æ“Šåœ“åœˆï¼Œç¶­æŒå®Œç¾å’Œè«§ï¼';
            } else if (planet === 'mercury') {
                modelPath = 'assets/æ°´æ˜Ÿèˆå°+äººç‰©å‹•ç•«.fbx';
                audioPath = 'assets/æ°´æ˜ŸéŸ³æ¨‚1.mp3'; // <-- å·²æ›´æ–°ç‚º 'æ°´æ˜ŸéŸ³æ¨‚1.mp3'
                title = 'æ­¡è¿ä¾†åˆ°æ°´æ˜Ÿèˆå°';
                intro = 'æ„Ÿå—Tranceçš„è¿·å¹»è„ˆå‹•ï¼Œé«”é©—Technoçš„é‡åŠ›åŠ é€Ÿåº¦ï¼';
            } else {
                return false; // ä¸æ”¯æ´çš„æ˜Ÿçƒ
            }

            // æ›´æ–°æ­¡è¿ç•«é¢æ–‡å­—
            document.getElementById('welcome-title').textContent = title;
            document.getElementById('welcome-intro').textContent = intro;
            
            // æ¸…ç†èˆŠéŸ³æ¨‚å’Œæ¨¡å‹
            if (ambientMusic && ambientMusic.isPlaying) ambientMusic.stop();
            ambientMusic = null;
            audioLoaded = false;
            
            // è¼‰å…¥æ–°æ¨¡å‹
            loadFBXModel(modelPath, () => {
                // æ¨¡å‹è¼‰å…¥æˆåŠŸå¾Œï¼Œè¼‰å…¥éŸ³æ¨‚
                loadAudio(audioPath); 
                changeState(GAME_STATE.WELCOME); 
            });

            return true;
        }


        function changeState(newState) {
            currentState = newState;
            console.log(`éŠæˆ²ç‹€æ…‹è®Šæ›´ç‚º: ${newState}`);
            
            const menuScreen = document.getElementById('menu-screen'); 
            const welcomeScreen = document.getElementById('welcome-screen');
            const summaryScreen = document.getElementById('summary-screen');
            const gameOverlay = document.getElementById('game-overlay');
            const pauseButton = document.getElementById('pause-button');
            const backButton = document.getElementById('back-button');
            const sceneInfo = document.getElementById('scene-info');
            const gameReference = document.getElementById('game-reference');
            const pauseMenu = document.getElementById('pause-menu');
            // é è¨­å…¨éƒ¨éš±è—/éæ´»å‹•
            menuScreen.classList.remove('visible');
            menuScreen.classList.add('hidden');
            document.getElementById('scene-container').classList.remove('active');
            welcomeScreen.style.display = 'none';
            welcomeScreen.classList.remove('fade-in');
            // é‡ç½®æ·¡å…¥æ•ˆæœ
            summaryScreen.style.display = 'none';
            gameOverlay.style.display = 'none';
            pauseButton.classList.remove('visible');
            backButton.classList.remove('visible');
            sceneInfo.classList.remove('visible');
            gameReference.style.display = 'none';
            pauseMenu.style.display = 'none';

            if (newState !== GAME_STATE.MENU) {
                document.getElementById('scene-container').classList.add('active');
            }

            if (newState === GAME_STATE.MENU) {
                menuScreen.classList.add('visible');
                menuScreen.classList.remove('hidden');
                currentPlanet = null; // è¿”å›ä¸»é¸å–®ï¼Œé‡ç½®ç•¶å‰æ˜Ÿçƒ
            } else if (newState === GAME_STATE.WELCOME) {
                welcomeScreen.style.display = 'flex';
                backButton.classList.add('visible'); // é€²å…¥æ­¡è¿ç•«é¢æ™‚ï¼Œå…è¨±è¿”å›ä¸»é¸å–®
                document.getElementById('welcome-message').textContent = audioLoaded ?
                'éŸ³æ¨‚å·²å°±ç·’ï¼Œé»æ“Šã€Œé–‹å§‹éŠæˆ²ã€å•Ÿå‹•ç¯€å¥ï¼' : 
                    'éŸ³æ¨‚è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...';
                // è§¸ç™¼æ·¡å…¥æ•ˆæœ
                setTimeout(() => {
                    welcomeScreen.classList.add('fade-in');
                }, 50);
            } else if (newState === GAME_STATE.PLAYING) {
                gameOverlay.style.display = 'block';
                pauseButton.classList.add('visible'); // éŠæˆ²ä¸­é¡¯ç¤ºæš«åœ
                sceneInfo.classList.add('visible');
                gameReference.style.display = 'block';
                // éŠæˆ²ä¸­ï¼Œback button éš±è—
            } else if (newState === GAME_STATE.PAUSED) {
                // æš«åœæ™‚ï¼Œé¡¯ç¤ºæš«åœé¸å–®
                gameOverlay.style.display = 'block';
                pauseButton.classList.add('visible');
                sceneInfo.classList.add('visible');
                gameReference.style.display = 'block';
                pauseMenu.style.display = 'flex'; // é¡¯ç¤ºæš«åœé¸å–®
            } else if (newState === GAME_STATE.SUMMARY) {
                summaryScreen.style.display = 'flex';
                backButton.classList.add('visible'); // çµç®—æ™‚ï¼Œå…è¨±è¿”å›ä¸»é¸å–®
                document.getElementById('final-score').textContent = score.toString().padStart(4, '0');
            }
        }

        async function startGame() {
            if (!ambientMusic || !ambientMusic.buffer) {
                alert('éŸ³æ¨‚å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å€™å†è©¦ã€‚');
                return;
            }

            // å¦‚æœæ˜¯å¾ SUMMARY é€²å…¥ï¼Œéœ€è¦é‡ç½®
            if (currentState === GAME_STATE.SUMMARY || currentState === GAME_STATE.WELCOME) {
                score = 0;
                nextNoteIndex = 0;
                audioStartTime = clock.elapsedTime;
                deltaPauseTime = 0;
                document.getElementById('hud-score').textContent = `SCORE: ${score.toString().padStart(4, '0')}`;
                // æ¸…ç†æ‰€æœ‰æ®˜ç•™çš„ç¯€å¥é»
                document.querySelectorAll('.beat-note').forEach(note => note.remove());
                // ç¢ºä¿éŸ³æ¨‚å¾é ­é–‹å§‹æ’­æ”¾
                if (ambientMusic.isPlaying) ambientMusic.stop();
            }

            changeState(GAME_STATE.PLAYING);
            document.getElementById('pause-button').textContent = 'â¸ æš«åœ';
            try {
                // å¼·åˆ¶æ¢å¾© AudioContext
                if (audioListener && audioListener.context.state !== 'running') {
                    await audioListener.context.resume();
                }

                if (audioListener.context.state === 'running') {
                    ambientMusic.play();
                    // é‡æ–°è¨ˆç®—éŸ³æ¨‚é–‹å§‹æ™‚é–“ (é˜²æ­¢åœ¨ resume å‰æœ‰å»¶é²)
                    audioStartTime = audioListener.context.currentTime;
                    console.log(`éŸ³æ¨‚é–‹å§‹æ’­æ”¾ï¼ŒAudioContext Time: ${audioStartTime}`);
                } else {
                    throw new Error('AudioContext ç„¡æ³•é‹è¡Œ');
                }

            } catch (err) {
                console.error('æ’­æ”¾å¤±æ•—:', err);
                alert(`éŸ³æ¨‚æ’­æ”¾å¤±æ•—ï¼è«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šæˆ–æ‰‹å‹•é»æ“Šæš«åœ/ç¹¼çºŒæŒ‰éˆ•ã€‚`);
                changeState(GAME_STATE.WELCOME); // è¿”å›æ­¡è¿ç•«é¢
                return;
            }
            
            document.getElementById('target-circle').addEventListener('mousedown', handleTap);
        }

        function pauseGame() {
            if (currentState !== GAME_STATE.PLAYING) return;
            changeState(GAME_STATE.PAUSED);
            
            // æš«åœéŸ³æ¨‚
            if (ambientMusic && ambientMusic.isPlaying) {
                ambientMusic.pause();
                // è¨˜éŒ„æš«åœæ™‚çš„ç¸½é‹è¡Œæ™‚é–“
                deltaPauseTime = clock.elapsedTime;
            }
            
            // æš«åœå‹•ç•«ï¼ˆåœ¨ animate è¿´åœˆä¸­è™•ç†ï¼‰
        }
        
         async function resumeGame() {
             if (currentState !== GAME_STATE.PAUSED) return;
             changeState(GAME_STATE.PLAYING);

             // æ¢å¾©éŸ³æ¨‚
             if (ambientMusic && audioLoaded) {
                 try {
                     if (audioListener && audioListener.context.state !== 'running') {
                         await audioListener.context.resume();
                     }
                     if (audioListener.context.state === 'running') {
                         ambientMusic.play();
                     } else {
                         throw new Error('AudioContext ç„¡æ³•åœ¨ resumeGame ä¸­æ¢å¾©');
                     }
                 } catch (err) {
                     console.error('æ¢å¾©æ’­æ”¾å¤±æ•—:', err);
                     alert('ç„¡æ³•æ¢å¾©éŸ³æ¨‚æ’­æ”¾ï¼Œè«‹é‡è©¦æˆ–é‡æ–°é–‹å§‹ã€‚');
                 }
             }

             // é‡ç½® clockï¼Œç¢ºä¿å‹•ç•«æ™‚é–“è»¸æ­£ç¢ºç¹¼çºŒ
             clock.start();
             // ç”±æ–¼æˆ‘å€‘åªåœ¨ PLAYING ç‹€æ…‹è¨ˆç®—ç¯€å¥ï¼Œæ‰€ä»¥å‹•ç•«æ¢å¾©å³å¯
        }

        function endGame() {
            if (currentState === GAME_STATE.SUMMARY) return;
            // åœæ­¢æ‰€æœ‰æ´»å‹•
            if (ambientMusic) {
                ambientMusic.stop();
            }
            
            // ç§»é™¤é»æ“Šäº‹ä»¶
            document.getElementById('target-circle').removeEventListener('mousedown', handleTap);
            // æ¸…ç†æ‰€æœ‰æ®˜ç•™çš„ç¯€å¥é»
            document.querySelectorAll('.beat-note').forEach(note => note.remove());

            changeState(GAME_STATE.SUMMARY);
            // é€²å…¥çµç®—ç•«é¢
        }

        function exitScene() {
             // åœæ­¢éŸ³æ¨‚
            if (ambientMusic) {
                ambientMusic.stop();
            }
            
            // æ¸…ç†æ‰€æœ‰æ®˜ç•™çš„ç¯€å¥é»
            document.querySelectorAll('.beat-note').forEach(note => note.remove());
            // ç§»é™¤é»æ“Šäº‹ä»¶
            document.getElementById('target-circle').removeEventListener('mousedown', handleTap);
            // è®Šæ›´ç‹€æ…‹ç‚º MENUï¼Œä»¥é¡¯ç¤ºä¸»é¸å–®
            changeState(GAME_STATE.MENU);
        }

        // ==================== ç¯€å¥èˆ‡é»æ“Šæ©Ÿåˆ¶ (ä¿æŒä¸è®Š) ====================

        function startNoteGeneration() {
            nextNoteIndex = 0;
        }

        function generateNote(targetTime) {
            const gameOverlay = document.getElementById('game-overlay');
            const note = document.createElement('div');
            note.className = 'beat-note';
            
            note.dataset.hitTime = (audioStartTime + targetTime).toFixed(3);
            
            note.style.top = '0%';
            // CSS transition è² è²¬å‹•ç•«ï¼Œå‹•ç•«æ™‚é–“ç‚º DROP_DURATION
            note.style.transition = `transform ${DROP_DURATION}s linear`;
            requestAnimationFrame(() => {
                note.style.transform = `translate(-50%, ${window.innerHeight * TARGET_Y}px)`; 
            });
            gameOverlay.appendChild(note);

            setTimeout(() => {
                if (gameOverlay.contains(note)) {
                    note.remove();
                    // å¯åœ¨æ­¤è™•åŠ å…¥ MISS é‚è¼¯
                }
            }, DROP_DURATION * 1000 + 50);
        }

        function handleTap(e) {
            if (currentState !== GAME_STATE.PLAYING) return;
            const targetCircle = document.getElementById('target-circle');
            const targetRect = targetCircle.getBoundingClientRect();
            const hitTolerance = 50;
            // å¾ 15 å¢åŠ åˆ° 50ï¼Œå¤§å¹…æå‡å®¹éŒ¯ç¯„åœ 
            
            const currentTime = audioListener.context.currentTime;
            // ä½¿ç”¨ AudioContext æ™‚é–“ä¾†ç²å¾—æ›´ç²¾ç¢ºçš„åŒæ­¥

            const activeNotes = document.querySelectorAll('.beat-note');
            let bestHit = null;
            let bestTimeDiff = Infinity;

            activeNotes.forEach(note => {
                const noteRect = note.getBoundingClientRect();
                const hitTime = parseFloat(note.dataset.hitTime);

                // æª¢æŸ¥ç¯€å¥é»æ˜¯å¦åœ¨é»æ“Šç›®æ¨™é™„è¿‘
                if (Math.abs(noteRect.bottom - targetRect.bottom) < hitTolerance) {
             
                    const timeDiff = Math.abs(currentTime - hitTime);

                    if (timeDiff < bestTimeDiff) {
                        bestTimeDiff = timeDiff;
                        bestHit = note;
            
                    }
                }
            });
            if (bestHit) {
                let feedback = '';
                let scoreIncrease = 0;

                if (bestTimeDiff < 0.15) { // å¤§å¹…æ”¾å¯¬å®¹å¿åº¦
                    feedback = 'PERFECT!';
                    scoreIncrease = 100;
                    bestHit.style.backgroundColor = 'lime';
                } else if (bestTimeDiff < 0.35) { 
                    feedback = 'GOOD';
                    scoreIncrease = 50;
                    bestHit.style.backgroundColor = 'yellow';
                } else if (bestTimeDiff < 0.6) {
                    feedback = 'OK';
                    scoreIncrease = 10;
                    bestHit.style.backgroundColor = 'orange';
                } else {
                    return;
                }

                displayFeedback(feedback);

                score += scoreIncrease;
                document.getElementById('hud-score').textContent = `SCORE: ${score.toString().padStart(4, '0')}`;
                
                setTimeout(() => bestHit.remove(), 100); 

            }
        }

        function displayFeedback(text) {
            const feedbackText = document.createElement('div');
            feedbackText.id = 'feedback-text';
            feedbackText.textContent = text;
            
            // é»æ“Šå›é¥‹é¡è‰²ä¿æŒä¸è®Š (å› ç‚ºå®ƒå€‘ä¸æ˜¯éœ“è™¹ç‡ˆé¢¨æ ¼)
            const colorMap = {
                'PERFECT!': '#00c8ff', 
                'GOOD': '#ff9800',
                'OK': '#ffffff',
                'MISS': '#ff0000'
        
            };
            feedbackText.style.color = colorMap[text] || 'white';

            const existing = document.getElementById('feedback-text');
            if (existing) existing.remove();
            
            document.body.appendChild(feedbackText);
            setTimeout(() => {
                feedbackText.style.opacity = 1;
                feedbackText.style.transform = 'translate(-50%, -50%) translateY(-20px) scale(1.1)';
            }, 10);
            setTimeout(() => {
                if (document.body.contains(feedbackText)) {
                    feedbackText.style.opacity = 0;
                    setTimeout(() => feedbackText.remove(), 200);
                }
            }, 300);
        }
        
        // ==================== 3D å ´æ™¯èˆ‡éŸ³é »åŠŸèƒ½ (ä¿æŒä¸è®Š) ====================

        function loadCubeMapBackground() {
            const loader = new THREE.CubeTextureLoader();
            loader.setPath('assets/'); 
            const urls = ['px.png', 'nx.png', 'py.png', 'ny.png', 'pz.png', 'nz.png'];
            loader.load(urls, function(texture) {
                texture.encoding = THREE.sRGBEncoding;
                scene.background = texture;
            }, undefined, function(err) {
                scene.background = new THREE.Color(0x0a0a1a);
            });
        }

        function loadAudio(audioPath) {
            
            document.getElementById('welcome-message').textContent = 'éŸ³æ¨‚è¼‰å…¥ä¸­...';
            
            const audioLoader = new THREE.AudioLoader();
            
            audioLoader.load(
                audioPath, 
                function(buffer) {
                    ambientMusic = new THREE.Audio(audioListener);
                    ambientMusic.setBuffer(buffer);
               
                    ambientMusic.setLoop(true); 
                    ambientMusic.setVolume(0.5); 
                    audioLoaded = true;
                    
                    if (currentState === GAME_STATE.WELCOME) {
       
                        document.getElementById('welcome-message').textContent = 'éŸ³æ¨‚å·²å°±ç·’ï¼Œé»æ“Šã€Œé–‹å§‹éŠæˆ²ã€å•Ÿå‹•ç¯€å¥ï¼';
                    }
                    console.log(`âœ… èƒŒæ™¯éŸ³æ¨‚ (${audioPath}) è¼‰å…¥æˆåŠŸ`);
                },
                undefined,
       
                function(err) {
                    audioLoaded = false;
                    const msg = 'âŒ éŸ³æ¨‚è¼‰å…¥å¤±æ•—';
                    if (currentState === GAME_STATE.WELCOME) {
                    
                        document.getElementById('welcome-message').textContent = `${msg}ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆåç¨± (${audioPath}) å’Œè·¯å¾‘ (assets/)ã€‚`;
                    }
                    console.error('âŒ éŸ³æ¨‚è¼‰å…¥å¤±æ•—', err);
                }
            );
        }

        function initScene() {
            if (sceneInitialized) return;
            const container = document.getElementById('scene-container');
            
            scene = new THREE.Scene();
            audioListener = new THREE.AudioListener();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.8, 0.1); 
            camera.add(audioListener);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio); 
            
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap; 
            renderer.outputEncoding = THREE.sRGBEncoding;
            container.appendChild(renderer.domElement);
            
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.target.set(0, 1.8, 0); 
            controls.enableZoom = false; 
            controls.enablePan = false;  
            controls.maxDistance = 0.1;
            controls.minDistance = 0.1;
            controls.maxPolarAngle = Math.PI * 0.7; 
            controls.minPolarAngle = Math.PI * 0.3; 
            controls.update();

            loadCubeMapBackground();
            const ambient = new THREE.AmbientLight(0xffffff, 2.5);
            scene.add(ambient);
            const dir1 = new THREE.DirectionalLight(0xffffff, 2.0);
            dir1.position.set(10, 20, 10);
            dir1.castShadow = true;
            dir1.shadow.mapSize.width = 4096; dir1.shadow.mapSize.height = 4096;
            dir1.shadow.camera.near = 0.5; dir1.shadow.camera.far = 50;
            dir1.shadow.camera.left = -20; dir1.shadow.camera.right = 20;
            dir1.shadow.camera.top = 20; dir1.shadow.camera.bottom = -20;
            dir1.shadow.camera.updateProjectionMatrix();
            scene.add(dir1);
            const dir2 = new THREE.DirectionalLight(0xffffff, 1.0);
            dir2.position.set(-10, 15, -10);
            scene.add(dir2);
            const p1 = new THREE.PointLight(0xff00ff, 1, 30); p1.position.set(-5, 5, -5); scene.add(p1);
            const p2 = new THREE.PointLight(0x00ffff, 1, 30);
            p2.position.set(5, 5, -5); scene.add(p2);
            const front = new THREE.PointLight(0xffffff, 0.8, 20); front.position.set(0, 3, 10); scene.add(front);
            
            clock = new THREE.Clock();
            sceneInitialized = true;
        }
        
        // ä¿®æ”¹ loadFBXModel å‡½å¼ä»¥æ¥å—æ¨¡å‹è·¯å¾‘
        function loadFBXModel(modelPath, callback) {
            const loadingDiv = document.getElementById('loading');
            loadingDiv.style.display = 'block';
            loadingDiv.textContent = 'è¼‰å…¥æ¨¡å‹ä¸­...';
            
            // æ¸…ç†å ´æ™¯ä¸­çš„èˆŠæ¨¡å‹
            if (scene) {
                const existingModel = scene.children.find(c => c.type === 'Group');
                if (existingModel) scene.remove(existingModel);
            }
            
            const loader = new THREE.FBXLoader();
            loader.load(
                modelPath,
                function(obj) {
                    obj.traverse(function(child) {
                        if (child.isMesh) {
                    
                            child.castShadow = true;
                            child.receiveShadow = false; 
                            if (child.isSkinnedMesh) {
                             
                                const oldMap = child.material.map || null;
                                child.material = new THREE.MeshStandardMaterial({
                                    skinning: true, map: oldMap, color: 0xffffff, side: THREE.DoubleSide, roughness: 0.5, metalness: 0.1 
         
                                });
                            }
                        }
                    });
     
                    
                    const box = new THREE.Box3().setFromObject(obj);
                    const size = box.getSize(new THREE.Vector3());
                    const maxDim = Math.max(size.x, size.y, size.z);
            
                    const desired = 5;
                    if (maxDim > desired) {
                        const scale = desired / maxDim;
                        obj.scale.set(scale, scale, scale);
                    }
                    
                    box.setFromObject(obj);
                    const center = box.getCenter(new THREE.Vector3());
                    obj.position.x = -center.x;
                    obj.position.y = -box.min.y; 
                    
                    // ğŸŒŸ ä¿®æ­£é»: æ ¹æ“šæ¨¡å‹èª¿æ•´è¦–è§’
                    if (modelPath.includes('æœ¨æ˜Ÿæ­Œæ‰‹+èˆå°.fbx')) {
                        // æœ¨æ˜Ÿ (åŸè¨­å®šï¼Œç¢ºä¿å…¶æ­£é¢é¢å‘æ”å½±æ©Ÿ)
                        obj.position.z = -center.z - 5;
                        obj.rotation.y = -Math.PI / 2; 
                    } else if (modelPath.includes('æ°´æ˜Ÿèˆå°+äººç‰©å‹•ç•«.fbx')) {
                        // **æ°´æ˜Ÿ (ä¿®æ­£: ç§»é™¤ 180 åº¦æ—‹è½‰ï¼Œè¨­ç‚º 0ï¼Œå‡è¨­æ¨¡å‹å°å‡ºæ™‚æ­£é¢æœå‰)**
                        obj.position.z = -center.z - 5; // å‘å¾Œæ¨ 5 å–®ä½
                        obj.rotation.y = 0; // **è¨­ç‚º 0**
                    } else {
                         // å…¶ä»–æ¨¡å‹ä½¿ç”¨é è¨­
                        obj.position.z = -center.z - 5;
                        obj.rotation.y = 0; 
                    }

                    scene.add(obj);
                    
                    if (obj.animations && obj.animations.length > 0) {
                        mixer = new THREE.AnimationMixer(obj);
                        mixer.clipAction(obj.animations[0]).play();
                    } else {
                        mixer = null; // å¦‚æœæ²’æœ‰å‹•ç•«ï¼Œç¢ºä¿ mixer æ˜¯ null
                    }
                    
                    loadingDiv.style.display = 'none';
                    console.log(`âœ… æ¨¡å‹ (${modelPath}) è¼‰å…¥æˆåŠŸ`);

                    if (callback) callback();
                },
                function(xhr) {
                    const p = (xhr.loaded / xhr.total * 100).toFixed(0);
                    loadingDiv.textContent = `è¼‰å…¥æ¨¡å‹... ${p}%`;
                },
                function(err) {
                    console.error(`âŒ æ¨¡å‹ (${modelPath}) è¼‰å…¥å¤±æ•—`, err);
                    loadingDiv.textContent = 'æ¨¡å‹è¼‰å…¥å¤±æ•—';
                    loadingDiv.style.background = 'rgba(200, 0, 0, 0.8)';
                }
            );
        }
        
        function enterScene(planet) {
            hideInfoBox();
            if (!sceneInitialized) {
                initScene();
            }
            
            currentPlanet = planet; // è¨­å®šç•¶å‰èˆå°
            document.getElementById('menu-screen').classList.add('hidden');

            if (!loadAssetForPlanet(planet)) {
                alert(`${planet} å ´æ™¯é–‹ç™¼ä¸­...`);
                document.getElementById('menu-screen').classList.remove('hidden'); 
            }
            
            if (!window.animating) {
                animate();
            }
        }
        
        function animate() {
            window.animating = true;
            animationFrameId = requestAnimationFrame(animate); // å„²å­˜ ID
            
            const delta = clock.getDelta();
            // åªæœ‰åœ¨ PLAYING ç‹€æ…‹æ‰é€²è¡Œå‹•ç•«æ›´æ–°å’Œç¯€å¥é»è¨ˆç®—
            if (currentState === GAME_STATE.PLAYING) {
                if (mixer) mixer.update(delta);
                controls.update();
                renderer.render(scene, camera);

                // è¨ˆç®—ç•¶å‰éŸ³æ¨‚æ’­æ”¾æ™‚é–“ (ä½¿ç”¨ AudioContext çš„ç²¾æº–æ™‚é–“)
                let musicTime = 0;
                if (ambientMusic && ambientMusic.isPlaying) {
                    // AudioContext.currentTime æ˜¯æœ€ç²¾æº–çš„ï¼Œä½†å®ƒä¸æ˜¯å¾ 0 é–‹å§‹
                    // audioStartTime æ˜¯éŸ³æ¨‚é–‹å§‹æ™‚çš„ AudioContext.currentTime
                    musicTime = audioListener.context.currentTime - audioStartTime;
                } else {
                     // å¦‚æœéŸ³æ¨‚åœæ­¢ï¼Œæˆ‘å€‘ä¹Ÿåœæ­¢éŠæˆ²æµç¨‹
                     return;
                }

                // ç¯€å¥é»ç”Ÿæˆé‚è¼¯
                if (nextNoteIndex < noteTimetable.length) {
                    const nextNoteTime = noteTimetable[nextNoteIndex];
                    if (musicTime >= nextNoteTime - DROP_DURATION) {
                        generateNote(nextNoteTime);
                        nextNoteIndex++;
                    }
                } else if (musicTime > noteTimetable[noteTimetable.length - 1] + DROP_DURATION + 1) {
                     // æ‰€æœ‰ç¯€å¥é»éƒ½ç”Ÿæˆä¸¦æœ‰è¶³å¤ çš„æ™‚é–“è½ä¸‹å¾Œï¼ŒçµæŸéŠæˆ²
                     endGame();
                }
            } else if (currentState === GAME_STATE.PAUSED || currentState === GAME_STATE.SUMMARY || currentState === GAME_STATE.WELCOME) {
                // æš«åœã€çµç®—æˆ–æ­¡è¿ç•«é¢æ™‚ï¼Œåªéœ€è¦æ¸²æŸ“å ´æ™¯å’Œæ›´æ–°ç›¸æ©Ÿæ§åˆ¶
                controls.update();
                renderer.render(scene, camera);
                // åœæ­¢ clockï¼Œé˜²æ­¢è¨ˆæ™‚å™¨ç¹¼çºŒç´¯ç©æ™‚é–“
                clock.getDelta();
            } else {
                 // MENU ç‹€æ…‹ï¼Œä¸éœ€è¦ Three.js æ¸²æŸ“
            }
        }
        
        // ==================== äº‹ä»¶ç›£è½ ====================
        document.getElementById('back-button').addEventListener('click', exitScene);
        // æš«åœæŒ‰éˆ•é‚è¼¯
        document.getElementById('pause-button').addEventListener('click', () => {
             if (currentState === GAME_STATE.PLAYING) {
                 pauseGame();
             }
        });
        // æš«åœé¸å–®æŒ‰éˆ•
        document.getElementById('resume-button').addEventListener('click', () => {
            if (currentState === GAME_STATE.PAUSED) {
                resumeGame();
            }
        });
        document.getElementById('home-button').addEventListener('click', () => {
            if (currentState === GAME_STATE.PAUSED) {
                exitScene();
            }
        });
        // çµç®—ç•«é¢çš„æŒ‰éˆ•
        document.getElementById('restart-game-button').addEventListener('click', startGame); 
        document.getElementById('exit-to-menu-button').addEventListener('click', exitScene);

        document.getElementById('start-game-button').addEventListener('click', startGame);
        /**
         * ğŸ§ å…¨å±€éŸ³é »å–šé†’å™¨ (Autoplay Policy Fix)
         */
        function resumeAudioContext() {
            if (audioListener && audioListener.context.state === 'suspended') {
                audioListener.context.resume().then(() => {
                    console.log('AudioContext æˆåŠŸå¾å…¨å±€é»æ“Šä¸­æ¢å¾©');
          
                }).catch(err => {
                    console.warn('AudioContext æ¢å¾©å¤±æ•—:', err);
                });
            }
        }
        
        document.addEventListener('click', (e) => {
            // è™•ç†ä¿¡æ¯æ¡†é—œé–‰
            const panel = document.getElementById('info-panel');
            if (activeInfoButton && !panel.contains(e.target) && !e.target.closest('.circle-button')) {
                hideInfoBox();
           
            }
            
            // åŸ·è¡Œå…¨å±€éŸ³é »å–šé†’ (ç¢ºä¿ AudioContext éš¨æ™‚æº–å‚™å¥½)
            if (sceneInitialized) {
                resumeAudioContext();
            }
        });
        window.addEventListener('resize', () => {
            createCircularButtons();
            
            if (sceneInitialized) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
      
            }
        });
        // ==================== åˆå§‹åŒ– ====================
        createCircularButtons();
    </script>
</body>
</html>